{{ define "main" }}
<section class="search-section">
  <h1 class="search-title">Search</h1>

  <div class="search-bar">
    <input
      id="search-input"
      class="search-input"
      type="text"
      autocomplete="off"
      placeholder="記事や作品のID、キーワードを入力してください。"
    />
  </div>

  <p id="search-message" class="search-message"></p>
  <div id="search-results" class="search-results"></div>
</section>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const input = document.getElementById("search-input");
  const message = document.getElementById("search-message");
  const resultsContainer = document.getElementById("search-results");

  let fuse;
  let searchData = [];

  message.textContent = "検索データを読み込み中...";

  try {
    const response = await fetch("/index.json");
    searchData = await response.json();

    const options = {
      keys: [
        { name: "title", weight: 0.8 },
        { name: "content", weight: 0.5 },
        { name: "summary", weight: 0.3 }
      ],
      threshold: 0.3, // 0 (perfect match) to 1 (match anything)
      ignoreLocation: true,
      includeMatches: true,
      minMatchCharLength: 2
    };
    fuse = new Fuse(searchData, options);
    message.textContent = ""; // Clear loading message
  } catch (error) {
    console.error("検索データの読み込みに失敗しました:", error);
    message.textContent = "検索データの読み込みに失敗しました。";
    return;
  }

  input.addEventListener("input", () => {
    if (input.value.trim().length > 0) {
      performSearch();
    } else {
      resultsContainer.innerHTML = "";
      message.textContent = "";
    }
  });

  function performSearch() {
    const query = input.value.trim();
    resultsContainer.innerHTML = ""; // Clear previous results

    if (!query) {
      message.textContent = "キーワードを入力してください。";
      return;
    }

    if (!fuse) {
      message.textContent = "検索エンジンが準備できていません。";
      return;
    }

    const results = fuse.search(query);

    if (results.length === 0) {
      message.textContent = `"${query}" に該当する記事・作品は見つかりませんでした。`;
      return;
    }

    message.textContent = `${results.length}件の結果が見つかりました。`;

    results.forEach((result, index) => {
      const item = result.item;
      const card = document.createElement("a");
      card.href = item.uri;
      card.classList.add("search-card");
      
      // Staggered animation
      card.style.animationDelay = `${index * 0.05}s`;

      card.innerHTML = `
        <h2>${item.title}</h2>
        <p>${item.summary}</p>
      `;
      resultsContainer.appendChild(card);
      
      // Add class to trigger animation after a short delay
      setTimeout(() => {
        card.classList.add("is-entering");
      }, 10);
    });
  }
});
</script>
{{ end }}
